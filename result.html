<!DOCTYPE html>
<html>

<head>
    <script src="dist/js/cookie.js"></script>
    <meta charset="utf-8" />
    <meta content="IE=edge" http-equiv="X-UA-Compatible" />
    <title>高教深耕彙整平台|成果報告管理</title>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport" />
    <link href="bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="bower_components/Ionicons/css/ionicons.min.css" rel="stylesheet" />
    <link href="bower_components/jvectormap/jquery-jvectormap.css" rel="stylesheet" />
    <link href="dist/css/AdminLTE.min.css" rel="stylesheet" />
    <link href="dist/css/skins/_all-skins.min.css" rel="stylesheet" />
    <link href="bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic"
        rel="stylesheet" />
    <style>
        .message {
            border-style: solid;
            border-color: gray;
            margin-left: 20px;
        }

        .popup {
            border-style: solid;
            border-color: gray;
            width: auto;
        }

        .deletebutton {
            margin-left: 20px;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        @media (max-width: 975px) {
            .message {
                width: auto;
                margin-right: 20px;
            }
        }

        .a_class {
            color: #000000;
            font-size: 18px;
        }
    </style>
</head>

<body class="hold-transition skin-blue sidebar-mini">
    <form>
        <div class="wrapper">
            <header class="main-header">
                <a class="logo" href="index.html" style="height: 64px"><span class="logo-mini"><b></b></span> <span
                        class="logo-lg"><b>高教深耕彙整平台</b></span></a>
                <nav class="navbar navbar-static-top">
                    <a class="sidebar-toggle" data-toggle="push-menu" href="#" role="button" style="height: 64px;"><span
                            class="sr-only">Toggle navigation</span></a>
                    <div class="navbar-custom-menu">
                        <ul class="nav navbar-nav">
                            <li class="dropdown user user-menu">
                                <a><span class="hidden-xs" id="username" style="font-size:20px">User Name&nbsp;</span>
                                    <span class="hidden-xs" id="usertitle" style="font-size:16px">User
                                        Title&nbsp;</span>
                                    <button class="btn" id="logout_btn" style="color:#707070" type="button">
                                        登出
                                    </button></a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </header>
            <aside class="main-sidebar">
                <section class="sidebar">
                    <ul class="sidebar-menu" data-widget="tree" id="menu"></ul>
                </section>
            </aside>
            <div class="content-wrapper" style="min-height: 960px;">
                <br />
                <section class="content-header">
                    <div class="container-fluid">
                        <div class="row">
                            <a style="font-size: 30px;color: #000000">報告書管理</a>
                            <a style="margin-left:20px;font-size: 24px;color:gray;">成果報告管理</a>
                        </div>
                        <br />
                        <div class="row">
                            <a style="font-size: 24px;color:gray;">年度(民國) :</a>
                            <select id="year"> </select>
                            <a style="font-size: 24px;color:gray;">註：預設為今年，年度列表為資料庫裡有資料之年度</a>
                        </div>
                        <br />
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="row" style="border-style:solid;border-color:gray">
                            <div style="margin-left:10px">
                                <h1 style="font-size: 20px">成果報告列表</h1>
                                <br />
                                <div class="box-body">
                                    <table class="table table-bordered table-striped" id="example1"
                                        style="border:1px #000000 solid;">
                                        <thead>
                                            <tr>
                                                <th style="display: none">ID</th>
                                                <th>主軸-分項-策略</th>
                                                <th>報告書名稱(活動或課程名稱)</th>
                                                <th>更新時間</th>
                                                <th>活動期限</th>
                                                <th>是否已填寫問卷</th>
                                                <th>狀態</th>
                                                <th>功能</th>
                                                <th>診斷小組審查</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
        <div class="modal fade" id="modal-default">
            <div class="modal-dialog" style="width:1000px">
                <div class="container-fluid">
                    <div class="modal-content">
                        <div class="modal-header" style="background-color:#5991C9">
                            <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <h4 class="modal-title" style="color:white">問卷填寫</h4>
                        </div>
                        <div class="modal-body">
                            <div class="box-body">
                                <div class="row">
                                    <div class="col-sm-12">
                                        <a style="color:#000000;font-size:22px">問卷類型&nbsp;&nbsp;</a>
                                        <select id="q_ver">
                                            <option value="a"> 請選擇問卷版本 </option>
                                        </select>
                                        <p>請填寫“半形”中、英、數字</p>
                                    </div>
                                </div>
                                <br />
                                <br />
                                <div class="cotainer">
                                    <div class="row" id="questions"></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-default" data-dismiss="modal" id="save_btn" type="button">
                                儲存
                            </button>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="modal-default2">
            <div class="modal-dialog" style="width:1000px">
                <div class="container-fluid">
                    <div class="modal-content">
                        <div class="modal-header" style="background-color:#5991C9">
                            <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <h4 class="modal-title" style="color:white">問卷填寫</h4>
                        </div>
                        <div class="modal-body">
                            <div class="box-body">
                                <div class="row">
                                    <div class="col-sm-12">
                                        <a style="color:#000000;font-size:22px">問卷類型&nbsp;&nbsp;</a>
                                        <select id="q_ver2">
                                            <option value="a"> 請選擇問卷版本 </option>
                                        </select>
                                    </div>
                                </div>
                                <br />
                                <br />
                                <div class="cotainer">
                                    <div class="row" id="questions2"></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-default" data-dismiss="modal" id="save_btn2" type="button">
                                儲存更新
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="modal-review">
            <div class="modal-dialog" style="width:1000px">
                <div class="container-fluid">
                    <div class="modal-content">
                        <div class="modal-header" style="background-color:#5991C9">
                            <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <h4 class="modal-title" style="color:white">診斷小組審查紀錄</h4>
                        </div>

                        <div class="modal-body">
                            <div class="box-body">
                                <div class="container-fluid">
                                    <div id="reply_msg">
                                        <div class="row" style="border-style:solid;border-color:#707070">
                                            <div class="col-sm-3" style="padding-top:1%"><span style="font-size:20px">回覆
                                                    : </span></div>
                                            <div class="col-sm-6" style="padding-top:1%"><textarea rows="5" cols="50"
                                                    id="review_msg"></textarea></div>
                                            <div class="col-sm-3" style="padding-top:8%"><button type="button"
                                                    class="btn btn-primary btn-sm" id="send_review_msg">送出</button>
                                            </div>
                                        </div>
                                    </div>
                                    <br>

                                    <div class="row review_table" style="border-style:solid;border-color:#707070;">
                                        <div style="margin-left: 2%;margin-right: 2%;margin-top: 2%;margin-bottom: 2%">
                                            <table class="table table-bordered table-striped" id="example3">
                                                <thead>
                                                    <tr>
                                                        <th style="display: none">ID</th>
                                                        <th>送件時間</th>
                                                        <th>送件者</th>
                                                        <th>審查人員</th>
                                                        <th>審查狀態</th>
                                                        <th>額外訊息</th>
                                                        <th>功能</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>0</td>
                                                        <td>0</td>
                                                        <td>0</td>
                                                        <td>0</td>
                                                        <td>0</td>
                                                        <td>0</td>
                                                        <td>0</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-default" data-dismiss="modal" type="button">
                                儲存
                            </button>

                        </div>
                    </div>
                </div>
            </div>
        </div>



        <div class="control-sidebar-bg"></div>
    </form>
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="bower_components/fastclick/lib/fastclick.js"></script>
    <script src="dist/js/adminlte.min.js"></script>
    <script src="bower_components/jquery-sparkline/dist/jquery.sparkline.min.js"></script>
    <script src="plugins/jvectormap/jquery-jvectormap-1.2.2.min.js"></script>
    <script src="plugins/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
    <script src="bower_components/jquery-slimscroll/jquery.slimscroll.min.js"></script>
    <script src="bower_components/chart.js/Chart.js"></script>
    <script src="bower_components/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="dist/js/demo.js"></script>
    <!-- Include dependencies -->
    <script type="text/javascript" src="plugins/docgen/libs/base64.js"></script>
    <script type="text/javascript" src="plugins/docgen/libs/jszip/jszip.js"></script>
    <script type="text/javascript" src="plugins/docgen/libs/jszip/jszip-load.js"></script>
    <script type="text/javascript" src="plugins/docgen/libs/jszip/jszip-inflate.js"></script>
    <script type="text/javascript" src="plugins/docgen/js/docxgen.js"></script>
    <script>

        $(function () {
            $("#example2").DataTable({
                paging: true,
                lengthChange: true,
                searching: false,
                ordering: false,
                info: true,
                autoWidth: false,
                oLanguage: {
                    sProcessing: "處理中...",
                    sLengthMenu: "顯示 _MENU_ 項結果",
                    sZeroRecords: "沒有匹配結果",
                    sInfo: "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
                    sInfoEmpty: "顯示第 0 至 0 項結果，共 0 項",
                    sInfoFiltered: "(從 _MAX_ 項結果過濾)",
                    sSearch: "搜尋:",
                    oPaginate: {
                        sFirst: "首頁",
                        sPrevious: "上一頁",
                        sNext: "下一頁",
                        sLast: "尾頁"
                    }
                }
            });
            $("#example3").DataTable({
                paging: true,
                lengthChange: true,
                searching: true,
                ordering: true,
                info: true,
                autoWidth: false,
                columnDefs: [
                    {
                        targets: [0],
                        visible: false
                    }
                ],
                order: [[1, "desc"]],
                oLanguage: {
                    sProcessing: "處理中...",
                    sLengthMenu: "顯示 _MENU_ 項結果",
                    sZeroRecords: "沒有匹配結果",
                    sInfo: "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
                    sInfoEmpty: "顯示第 0 至 0 項結果，共 0 項",
                    sInfoFiltered: "(從 _MAX_ 項結果過濾)",
                    sSearch: "搜尋:",
                    oPaginate: {
                        sFirst: "首頁",
                        sPrevious: "上一頁",
                        sNext: "下一頁",
                        sLast: "尾頁"
                    }
                }
            });
            $("#example1").DataTable({
                paging: true,
                lengthChange: true,
                searching: true,
                ordering: true,
                info: true,
                autoWidth: false,
                columnDefs: [
                    {
                        targets: [0],
                        visible: false
                    }
                ],
                oLanguage: {
                    sProcessing: "處理中...",
                    sLengthMenu: "顯示 _MENU_ 項結果",
                    sZeroRecords: "沒有匹配結果",
                    sInfo: "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
                    sInfoEmpty: "顯示第 0 至 0 項結果，共 0 項",
                    sInfoFiltered: "(從 _MAX_ 項結果過濾)",
                    sSearch: "搜尋:",
                    oPaginate: {
                        sFirst: "首頁",
                        sPrevious: "上一頁",
                        sNext: "下一頁",
                        sLast: "尾頁"
                    }
                }
            });


        });

        function generateDoc(docData, pid) {
            var doc = new DocxGen(docData)
            SetCookie("sno_projects", pid, 1, domain);
            document.location.href = "phpMod/question_percentage.php";
        }

        function edit_fun(pid) {
            var pid_split = pid.split("_");
            var new_pid = pid_split[1];
            var token = GetCookie("token");
            SetCookie("pid", new_pid, 1, domain);
            document.location.href = "result2.html";
        }

        function detail_fun(pid) {
            var token = GetCookie("token");
            SetCookie("pid", pid, 1, domain);
            document.location.href = "result3.html";
        }
        function get_review_list(pid) {
            $("#reply_msg").hide();
            var token = GetCookie("token");
            var review_table = $("#example3").DataTable();
            review_table.clear().draw();
            $.ajax({
                type: "POST",
                url: "phpMod/paper_review_get_list.php",
                async: false, ///非同步執行
                dataType: "json",
                data: {
                    token: token,
                    sno_option_projects: pid
                },
                success: function (data) {
                    if (checkMsg(data.msg)) {
                        console.log("review:", data.out);

                        for (var i = 0; i < data.out.length; i++) {
                            var data_array = data.out[i];
                            review_table.row
                                .add([
                                    data_array["sno_reviewed"],
                                    data_array["updated_at"],
                                    data_array["review_name"],
                                    data_array["send_name"],
                                    data_array["need_reply"],
                                    data_array["message"],
                                    '<button type="button" class="btn btn-primary btn-sm " id="btn_reply" >回覆</button>'
                                ])
                                .draw();
                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                }
            });
        }



        function q_fun(pid) {
            $("#questions").empty();
            $("#questions2").empty();
            var pid_split = pid.split("_");
            var new_pid = pid_split[1];
            SetCookie("pid", new_pid, 1, domain);
            $("#q_ver").val("a");
            $("#questions").empty();
            var token = GetCookie("token");
            $("#q_ver").on("change", function () {
                $("#questions").empty();
                var type = $(this).val();
                console.log(type);
                $.ajax({
                    type: "POST",
                    url: "phpMod/question_topic_serve.php",
                    async: false, ///非同步執行
                    dataType: "json",
                    data: {
                        token: token,
                        type: type
                    },
                    success: function (data) {
                        checkToken(data.msg);
                        if (checkMsg(data.msg)) {
                            var questions = data.outt;
                            console.log(questions);
                            var q_length = questions.length;
                            var sub_length;
                            for (var i = 0; i < q_length; i++) {
                                $("#questions").append(
                                    '<div class="row"id="' +
                                    "group" +
                                    i +
                                    '">' +
                                    '<div class="col-sm-12 " >' +
                                    '<p style="margin-bottom:0"><span style="color:gray;font-size:25px">' +
                                    questions[i]["groupname"] +
                                    "<\/span><\/p>" +
                                    '<hr style="margin-top:0"><\/div>' +
                                    "<br>"
                                );
                                var group_div_id = "group" + i;
                                for (var j = 0; j < questions[i]["topic"].length; j++) {
                                    var question_div_id = group_div_id + "_" + j;
                                    $("#" + group_div_id).append(
                                        '<div class="row qrow">' +
                                        '<div class="col-sm-6 qcol" >' +
                                        '<a class="a_class" style="margin-left:10%">' +
                                        questions[i]["topic"][j]["question"] +
                                        "</a>" +
                                        "</div>" +
                                        '<div class="row" id=' +
                                        question_div_id +
                                        "></div>" +
                                        "</div><br>"
                                    );

                                    var sub_length = questions[i]["topic"][j]["sub"].length;
                                    if (sub_length == 1) {
                                        for (var k = sub_length - 1; k >= 0; --k) {
                                            $("#" + question_div_id).after(
                                                '<div class="row ">' +
                                                '<div class="col-sm-2 " >' +
                                                "</div>" +
                                                '<div class="col-sm-3 " style="" >' +
                                                '<a class="a_class">' +
                                                questions[i]["topic"][j]["sub"][k]["subquestion"] +
                                                "</a></div> <div class='col-sm-3'>" +
                                                '<textarea class="sub_res" rows="5" cols="30" id="q' +
                                                questions[i]["topic"][j]["sub"][k]["subqid"] +
                                                '"></textarea>' +
                                                "</div>" +
                                                "</div><br>"
                                            );
                                            console.log(questions[i]["topic"][j]["sub"][k]["subqid"]);
                                            //$('#' + questions[i]["topic"][j]["sub"][k]["subqid"]).val("0");
                                            console.log($('#' + questions[0]["topic"][0]["sub"][0]["subqid"]).val());
                                        }
                                    }
                                    else {
                                        for (var k = sub_length - 1; k >= 0; --k) {
                                            $("#" + question_div_id).after(
                                                '<div class="row ">' +
                                                '<div class="col-sm-2 " >' +
                                                "</div>" +
                                                '<div class="col-sm-3 " style="" >' +
                                                '<a class="a_class">' +
                                                questions[i]["topic"][j]["sub"][k]["subquestion"] +
                                                "</a></div> <div class='col-sm-3'>" +
                                                '<input class="sub_res" type="text" size="10px" id="q' +
                                                questions[i]["topic"][j]["sub"][k]["subqid"] +
                                                '">' +
                                                "&nbsp人</div>" +
                                                "</div><br>"
                                            );
                                            console.log(questions[i]["topic"][j]["sub"][k]["subqid"]);
                                            //$('#' + questions[i]["topic"][j]["sub"][k]["subqid"]).val("0");
                                            console.log($('#' + questions[0]["topic"][0]["sub"][0]["subqid"]).val());
                                        }
                                    }

                                }
                            }
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                    }
                });
            });

        }

        function q_edit(pid) {
            var pid_split = pid.split("_");
            var new_pid = pid_split[1];
            $("#questions").empty();
            $("#questions2").empty();
            SetCookie("pid", new_pid, 1, domain);
            var token = GetCookie("token");
            $("#q_ver2").val("a");
            $("body").on("change", "#q_ver2", function () {
                $("#questions2").empty();
                var category = $("#q_ver2").val();
                console.log(category);
                $.ajax({
                    type: "POST",
                    url: "phpMod/question_get.php",
                    async: false, ///非同步執行
                    dataType: "json",
                    data: {
                        token: token,
                        sno_projects: new_pid,
                        category: category
                    },
                    success: function (data) {
                        checkToken(data.msg);
                        if (checkMsg(data.msg)) {
                            console.log(data);
                            var q_length = data.out["sub"].length;
                            var questions = data.out["sub"];
                            for (var i = 0; i < q_length; i++) {
                                $("#questions2").append(
                                    '<div class="row"id="' +
                                    "editgroup" +
                                    i +
                                    '">' +
                                    '<div class="col-sm-12 " >' +
                                    '<p style="margin-bottom:0"><span style="color:gray;font-size:25px">' +
                                    questions[i]["groupname"] +
                                    "<\/span><\/p>" +
                                    '<hr style="margin-top:0"><\/div>' +
                                    "<br>"
                                );
                                var group_div_id = "editgroup" + i;
                                for (var j = 0; j < questions[i]["topic"].length; j++) {
                                    var question_div_id = group_div_id + "_" + j;
                                    $("#" + group_div_id).append(
                                        '<div class="row qrow2">' +
                                        '<div class="col-sm-6 qcol" >' +
                                        '<a class="a_class" style="margin-left:10%">' +
                                        questions[i]["topic"][j]["question"] +
                                        "<\/a>" +
                                        "<\/div>" +
                                        '<div class="row" id=' +
                                        question_div_id +
                                        "><\/div>" +
                                        "<\/div><br>"
                                    );

                                    var sub_length = questions[i]["topic"][j]["sub"].length;
                                    if (sub_length == 1) {
                                        for (var k = sub_length - 1; k >= 0; --k) {
                                            $("#" + question_div_id).after(
                                                '<div class="row ">' +
                                                '<div class="col-sm-2 " >' +
                                                "</div>" +
                                                '<div class="col-sm-3 " style="" >' +
                                                '<a class="a_class">' +
                                                questions[i]["topic"][j]["sub"][k]["subquestion"] +
                                                '<\/a></div><div class="col-sm-3 " style="">' +
                                                '<textarea class="edit_sub_res" rows="5" cols="30" id="qe' +
                                                questions[i]["topic"][j]["sub"][k]["sno_questionnaires_results"] +
                                                '"></textarea>' +
                                                "</div>" +
                                                "</div><br>"
                                            );

                                            $("#qe" + questions[i]["topic"][j]["sub"][k]["sno_questionnaires_results"]).val(questions[i]["topic"][j]["sub"][k]["result"]);

                                        }
                                    }
                                    else {
                                        for (var k = sub_length - 1; k >= 0; --k) {
                                            $("#" + question_div_id).after(
                                                '<div class="row ">' +
                                                '<div class="col-sm-2 " >' +
                                                "</div>" +
                                                '<div class="col-sm-3 " style="" >' +
                                                '<a class="a_class">' +
                                                questions[i]["topic"][j]["sub"][k]["subquestion"] +
                                                '<\/a></div><div class="col-sm-3 " style="">' +
                                                '<input type="text" class="edit_sub_res" size="10px" id="qe' +
                                                questions[i]["topic"][j]["sub"][k]["sno_questionnaires_results"] +
                                                '">' +
                                                "人</div>" +
                                                "</div><br>"
                                            );

                                            $("#qe" + questions[i]["topic"][j]["sub"][k]["sno_questionnaires_results"]).val(questions[i]["topic"][j]["sub"][k]["result"]);
                                            console.log($("#" + questions[0]["topic"][0]["sub"][0]["sno_questionnaires_results"]).val());
                                        }
                                    }

                                }
                            }
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                    }
                });
            });

        }


        $(document).ready(function () {

            var opt = {
                columnDefs: [
                    {
                        targets: [0],
                        visible: false
                    }
                ],
                oLanguage: {
                    sProcessing: "處理中...",
                    sLengthMenu: "顯示 _MENU_ 項結果",
                    sZeroRecords: "沒有匹配結果",
                    sInfo: "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
                    sInfoEmpty: "顯示第 0 至 0 項結果，共 0 項",
                    sInfoFiltered: "(從 _MAX_ 項結果過濾)",
                    sSearch: "搜尋:",
                    oPaginate: {
                        sFirst: "首頁",
                        sPrevious: "上一頁",
                        sNext: "下一頁",
                        sLast: "尾頁"
                    }
                }
            };
            var y = new Date();
            var year_now = y.getFullYear() - 1911;
            console.log(year_now);
            var token = GetCookie("token");

            var t = $("#example1").DataTable();
            var user_name = GetCookie("user_name");
            $("#username").text(user_name);
            var usertitle = GetCookie("role_name");
            $("#usertitle").text(usertitle);

            $.ajax({
                type: "POST",
                url: "phpMod/select_project_yyy.php",
                async: false, ///非同步執行
                dataType: "json",
                data: {
                    token: token
                },
                success: function (data) {
                    if (checkMsg(data.msg)) {
                        var years = data.out;
                        for (var i = 0; i < years.length; i++) {
                            var o = new Option(years[i], years[i]);
                            $("#year").append(o);
                        }
                        $("#year").val(years[0]);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                }
            });

            $.ajax({
                type: "POST",
                url: "phpMod/question_get_version.php",
                async: false,
                dataType: "json",
                data: {
                    token: token
                },
                success: function (data) {
                    if (checkMsg(data.msg)) {
                        var version = data.version;
                        for (var i = 0; i < version.length; i++) {
                            var o = new Option(version[i].name, version[i].sno_questionnarie_category);
                            $("#q_ver").append(o);

                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                }
            });
            $.ajax({
                type: "POST",
                url: "phpMod/question_get_version.php",
                async: false,
                dataType: "json",
                data: {
                    token: token
                },
                success: function (data) {
                    if (checkMsg(data.msg)) {
                        var version = data.version;
                        for (var i = 0; i < version.length; i++) {
                            var o = new Option(version[i].name, version[i].sno_questionnarie_category);

                            $("#q_ver2").append(o);
                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                }
            });
            var year = $("#year").val();

            $.ajax({
                type: "POST",
                url: "phpMod/find_project_serve.php",
                async: false, ///非同步執行
                dataType: "json",
                data: {
                    token: token,
                    year: year
                },
                success: function (data) {
                    if (!checkMsg(data.msg)) {
                        DelCookie("token", domain);
                        document.location.href = "login.html";
                    }
                    if (checkMsg(data.msg)) {
                        for (var i = 0; i < data.outt.length; i++) {
                            var data_array = JSON.parse(data.outt[i]);
                            console.log(data_array);
                            var pid = data_array["pid"];
                            var project_name = data_array["project_name"];
                            var update_time = data_array["update_time"];
                            var estimated_date = data_array["estimated_date"];
                            var is_filled_result = data_array["is_filled_result"];
                            var review_state = data_array["review_state"];
                            var order = data_array["order"];
                            var on_this_man = data_array["edit"];
                            if (is_filled_result == 0) {
                                t.row
                                    .add([
                                        pid,
                                        order,
                                        project_name,
                                        update_time,
                                        estimated_date,
                                        "未填寫問卷",
                                        review_state,
                                        "<button type='button'  class='btn btn-warning btn-sm' onClick=edit_fun(this.id) id='editbtn_" +
                                        pid +
                                        "' value='" +
                                        pid +
                                        "'>編輯<\/button><button type='button' class='btn bg-olive btn-sm' onClick=detail_fun(this.id) id=" +
                                        pid +
                                        " value='" +
                                        pid +
                                        "'>詳細資料<\/button><button type='button' class='btn bg-purple btn-sm' id='questionbtn_" +
                                        pid +
                                        "' value='" +
                                        pid +
                                        "'data-toggle='modal' data-target='#modal-default' onClick=q_fun(this.id)>問卷填寫<\/button>" +
                                        "<button type='button' class='btn bg-blue btn-sm'  id='" +
                                        pid +
                                        "'value='" +
                                        pid + "'data-toggle='modal'  onClick='generateDoc(window.docData,this.id)'>匯出報告書<\/button>",
                                        "<button type='button' class='btn btn-primary btn-sm' id='review' data-toggle='modal' data-target='#modal-review' >審查紀錄<\/button>"
                                    ])
                                    .draw(false);

                            } else {
                                t.row
                                    .add([
                                        pid,
                                        order,
                                        project_name,
                                        update_time,
                                        estimated_date,
                                        "已填寫問卷",
                                        review_state,

                                        "<button type='button'  class='btn btn-warning btn-sm' onClick=edit_fun(this.id) id='editbtn_" +
                                        pid +
                                        "' value='" +
                                        pid +
                                        "'>編輯<\/button><button type='button' class='btn bg-olive btn-sm' onClick=detail_fun(this.id) id='" +
                                        pid +
                                        " 'value='" +
                                        pid +
                                        "'>詳細資料<\/button><button type='button' class='btn bg-purple btn-sm' id='qeditbtn_" +
                                        pid +
                                        "' value='" +
                                        pid +
                                        "'data-toggle='modal' data-target='#modal-default2' onClick=q_edit(this.id)>編輯問卷<\/button>" +
                                        "<button type='button' class='btn bg-blue btn-sm'  id='" +
                                        pid +
                                        "'value='" +
                                        pid + "'data-toggle='modal'  onClick='generateDoc(window.docData,this.id)'>匯出報告書<\/button>",
                                        "<button type='button' class='btn btn-primary btn-sm' id='review'data-toggle='modal' data-target='#modal-review' >審查紀錄<\/button>"
                                    ])
                                    .draw(false);
                            }
                            if (review_state == "審核完成") {
                                $("#editbtn_" + pid).hide();
                            }
                            // if (on_this_man == 0) {
                            //     $("#editbtn_" + pid).hide();
                            // }
                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                }
            });

            $("#year").on("change", function () {
                // if ($("#q_ver").val() == "a") {
                //     $("#save_btn").hide();
                // } else $("#save_btn").show();
                t.clear();
                year = $("#year").val();
                $.ajax({
                    type: "POST",
                    url: "phpMod/find_project_serve.php",
                    async: false, ///非同步執行
                    dataType: "json",
                    data: {
                        token: token,
                        year: year
                    },
                    success: function (data) {
                        if (!checkMsg(data.msg)) {
                            DelCookie("token", domain);
                            document.location.href = "login.html";
                        }
                        if (checkMsg(data.msg)) {
                            for (var i = 0; i < data.outt.length; i++) {
                                var data_array = JSON.parse(data.outt[i]);
                                console.log(data_array);
                                var pid = data_array["pid"];
                                var project_name = data_array["project_name"];
                                var update_time = data_array["update_time"];
                                var estimated_date = data_array["estimated_date"];
                                var is_filled_result = data_array["is_filled_result"];
                                var review_state = data_array["review_state"];
                                var order = data_array["order"];
                                var on_this_man = data_array["edit"];
                                if (is_filled_result == 0) {
                                    t.row
                                        .add([
                                            pid,
                                            order,
                                            project_name,
                                            update_time,
                                            estimated_date,
                                            "未填寫問卷",
                                            review_state,
                                            "<button type='button'  class='btn btn-warning btn-sm' onClick=edit_fun(this.id) id='editbtn_" +
                                            pid +
                                            "' value='" +
                                            pid +
                                            "'>編輯<\/button><button type='button' class='btn bg-olive btn-sm' onClick=detail_fun(this.id) id=" +
                                            pid +
                                            " value='" +
                                            pid +
                                            "'>詳細資料<\/button><button type='button' class='btn bg-purple btn-sm' id='questionbtn_" +
                                            pid +
                                            "' value='" +
                                            pid +
                                            "'data-toggle='modal' data-target='#modal-default' onClick=q_fun(this.id)>問卷填寫<\/button>" +
                                            "<button type='button' class='btn bg-blue btn-sm'  id='" +
                                            pid +
                                            "'value='" +
                                            pid + "'data-toggle='modal'  onClick='generateDoc(window.docData,this.id)'>匯出報告書<\/button>",
                                            "<button type='button' class='btn btn-primary btn-sm' id='review' data-toggle='modal' data-target='#modal-review' >審查紀錄<\/button>"
                                        ])
                                        .draw(false);

                                } else {
                                    t.row
                                        .add([
                                            pid,
                                            order,
                                            project_name,
                                            update_time,
                                            estimated_date,
                                            "已填寫問卷",
                                            review_state,

                                            "<button type='button'  class='btn btn-warning btn-sm' onClick=edit_fun(this.id) id='editbtn_" +
                                            pid +
                                            "' value='" +
                                            pid +
                                            "'>編輯<\/button><button type='button' class='btn bg-olive btn-sm' onClick=detail_fun(this.id) id='" +
                                            pid +
                                            " 'value='" +
                                            pid +
                                            "'>詳細資料<\/button><button type='button' class='btn bg-purple btn-sm' id='qeditbtn_" +
                                            pid +
                                            "' value='" +
                                            pid +
                                            "'data-toggle='modal' data-target='#modal-default2' onClick=q_edit(this.id)>編輯問卷<\/button>" +
                                            "<button type='button' class='btn bg-blue btn-sm'  id='" +
                                            pid +
                                            "'value='" +
                                            pid + "'data-toggle='modal'  onClick='generateDoc(window.docData,this.id)'>匯出報告書<\/button>",
                                            "<button type='button' class='btn btn-primary btn-sm' id='review'data-toggle='modal' data-target='#modal-review' >審查紀錄<\/button>"
                                        ])
                                        .draw(false);
                                }
                                if (review_state == "審核完成") {
                                    $("#editbtn_" + pid).hide();
                                }
                                // if (on_this_man == 0) {
                                //     $("#editbtn_" + pid).hide();
                                // }
                            }
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                    }
                });
            });

            $("#logout_btn").click(function () {
                $.ajax({
                    type: "POST",
                    url: "phpMod/signout_serve.php",
                    async: false, ///非同步執行
                    dataType: "json",
                    data: {
                        token: token
                    },
                    success: function (data) {
                        if (checkMsg(data.msg)) {
                            delete_all_cookie();
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                    }
                });
            });



            $("#save_btn").click(function () {
                var pid = GetCookie("pid");
                var subqid = [];
                var result = [];
                $(".sub_res").each(function (index) {
                    subqid[index] = $(this).attr("id").substr(1);
                    console.log($(this).val());
                    if ($(this).val() == "" || $(this).val() == null || $(this).val() == undefined) {
                        result[index] = 0;
                    }
                    else
                        result[index] = $(this).val();

                });

                var answer = JSON.stringify({
                    subqid: subqid,
                    result: result
                });
                console.log(answer);
                console.log(pid);
                $.ajax({
                    type: "POST",
                    url: "phpMod/update_question_serve.php",
                    async: false, ///非同步執行
                    dataType: "json",
                    data: {
                        pid: pid,
                        answer: answer
                    },
                    success: function (data) {
                        if (checkMsg(data.msg)) {
                            alert("已填寫問卷");
                            document.location.href = "result.html";
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                    }
                });
            });
            //問卷編輯送出
            $("#save_btn2").click(function () {
                var token = GetCookie("token");
                var pid = GetCookie("pid");
                var sno_questionnaires_results = [];
                var result = [];
                $(".edit_sub_res").each(function (index) {
                    sno_questionnaires_results[index] = $(this).attr("id").substr(2);
                    console.log($(this).attr("id"));
                    console.log(sno_questionnaires_results[index]);
                    if ($(this).val() == "" || $(this).val() == null || $(this).val() == undefined) {
                        result[index] = 0;
                    }
                    else
                        result[index] = $(this).val();
                });

                $.ajax({
                    type: "POST",
                    url: "phpMod/question_update.php",
                    async: false, ///非同步執行
                    dataType: "json",
                    data: {
                        token: token,
                        sno_questionnaires_results: sno_questionnaires_results,
                        result: result
                    },
                    success: function (data) {
                        if (checkMsg(data.msg)) {
                            alert("編輯成功");
                            document.location.href = "result.html";
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                    }
                });
            });

            $.ajax({
                type: "POST",
                url: "phpMod/menu.php",
                async: false, ///非同步執行
                dataType: "json",
                data: {
                    token: token,
                    page: 3,
                    subpage: 2
                },
                success: function (data) {
                    if (checkMsg(data.msg)) {
                        var menu = data.remenu;

                        $("#menu").append(menu);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                }
            });

            $("#example1 tbody").on("click", "button#review", function () {
                $("#reply_msg").hide();
                var token = GetCookie("token");
                var data = t.row($(this).parents("tr")).data();
                var pid = data[0];
                SetCookie("pid", pid, 1, domain);
                console.log(data);
                var review_table = $("#example3").DataTable();
                review_table.clear().draw();
                $.ajax({
                    type: "POST",
                    url: "phpMod/paper_review_get_list.php",
                    async: false, ///非同步執行
                    dataType: "json",
                    data: {
                        token: token,
                        sno_option_projects: pid
                    },
                    success: function (data) {

                        if (checkMsg(data.msg)) {
                            console.log("review:", data.out);

                            for (var i = 0; i < data.out.length; i++) {
                                var data_array = data.out[i];
                                if (data_array["need_reply"] == "已審查待回復") {
                                    review_table.row
                                        .add([
                                            data_array["sno_reviewed"],
                                            data_array["updated_at"],
                                            data_array["review_name"],
                                            data_array["send_name"],
                                            data_array["need_reply"],
                                            data_array["message"],
                                            '<button type="button" class="btn btn-primary btn-sm " id="btn_reply" >回覆</button>'
                                        ])
                                        .draw();
                                }
                                else {
                                    review_table.row
                                        .add([
                                            data_array["sno_reviewed"],
                                            data_array["updated_at"],
                                            data_array["review_name"],
                                            data_array["send_name"],
                                            data_array["need_reply"],
                                            data_array["message"],
                                            ''
                                        ])
                                        .draw();
                                }

                            }
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                    }
                });

            });

            $("#example3 tbody").on("click", "button#btn_reply", function () {
                var review_table = $("#example3").DataTable();
                var data = review_table.row($(this).parents("tr")).data();
                var review_id = data[0];
                //console.log(data);
                SetCookie("review_id", data[0], 1, domain);
                $("#reply_msg").show();
                $("#review_msg").val("");
            });

            $("#send_review_msg").on("click", function () {
                var review_id = GetCookie("review_id");
                var pid = GetCookie("pid");
                console.log(review_id);
                var token = GetCookie("token");
                var message = $("#review_msg").val();
                console.log(message);
                $.ajax({
                    type: "POST",
                    url: "phpMod/paper_review_reply.php",
                    async: false, ///非同步執行
                    dataType: "json",
                    data: {
                        token: token,
                        sno_reviewed: review_id,
                        message: message
                    },
                    success: function (data) {
                        if (checkMsg(data.msg)) {
                            console.log(data.msg);
                            get_review_list(pid);
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                    }
                });
            });




            // function send_review_msg(review_id) {

            //     console.log(review_id);
            //     var token = GetCookie("token");
            //     var message = $("#review_msg").val();
            //     console.log(message);
            //     $.ajax({
            //         type: "POST",
            //         url: "phpMod/paper_review_reply.php",
            //         async: false, ///非同步執行
            //         dataType: "json",
            //         data: {
            //             token: token,
            //             sno_reviewed: review_id,
            //             message: message
            //         },
            //         success: function (data) {
            //             if (checkMsg(data.msg)) {
            //                 console.log(data.msg);
            //             }
            //         },
            //         error: function (XMLHttpRequest, textStatus, errorThrown) {
            //             alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
            //         }
            //     });
            // }




        });
    </script>
</body>

</html>