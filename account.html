<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta content="IE=edge" http-equiv="X-UA-Compatible" />
    <title>高教深耕彙整平台|帳號管理</title>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport" />
    <link href="bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="bower_components/Ionicons/css/ionicons.min.css" rel="stylesheet" />
    <link href="bower_components/jvectormap/jquery-jvectormap.css" rel="stylesheet" />
    <link href="dist/css/AdminLTE.min.css" rel="stylesheet" />
    <link href="dist/css/skins/_all-skins.min.css" rel="stylesheet" />
    <link href="bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic" rel="stylesheet" />
    <style>
        .message {
            border-style: solid;
            border-color: gray;
            margin-left: 20px;
            width: auto;
        }
        
        .popup {
            border-style: solid;
            border-color: gray;
            width: auto;
        }
        
        .deletebutton {
            margin-left: 20px;
            margin-top: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body class="hold-transition skin-blue sidebar-mini">
    <form>
        <div class="wrapper">
            <header class="main-header">
                <a class="logo" href="index.html" style="height: 64px"><span class="logo-mini"><b></b></span> <span
                        class="logo-lg"><b>高教深耕彙整平台</b></span></a>
                <nav class="navbar navbar-static-top">
                    <a class="sidebar-toggle" data-toggle="push-menu" href="#" role="button" style="height: 64px;"><span
                            class="sr-only">Toggle navigation</span></a>
                    <div class="navbar-custom-menu">
                        <ul class="nav navbar-nav">
                            <li class="dropdown user user-menu">
                                <a><span class="hidden-xs" id="username" style="font-size:20px">User Name&nbsp;</span>
                                    <span class="hidden-xs" id="usertitle" style="font-size:16px">User Title&nbsp;</span>
                                    <button class="btn" id="logout_btn" style="color:#707070" type="button">
                                        登出
                                    </button></a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </header>
            <aside class="main-sidebar">
                <section class="sidebar">
                    <ul class="sidebar-menu" data-widget="tree" id="menu"></ul>
                </section>
            </aside>
            <div class="content-wrapper" style="min-height: 960px;">
                <br />
                <section class="content-header">
                    <div class="container-fluid">
                        <h1 style="margin-left:20px;font-size: 30px">帳號管理</h1>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="row message" style="border-radius: 15px;height:auto">
                            <div class="row">
                                <div class="col-xs-4" style="margin-top:10px">
                                    <a style="color:black;">帳號 :</a> <input style="margin: auto" id="new_acc" type="text" />
                                </div>
                                <div class="col-xs-4" style="margin-top:10px">
                                    <a style="color:black;">姓名 :</a> <input style="margin: auto" id="new_name" type="text" />
                                </div>
                                <div class="col-xs-4" style="margin-top:10px">
                                    <a style="color:black;">信箱 :</a> <input style="margin: auto" id="new_email" type="text" />
                                </div>
                            </div>
                            <div class="col-xs-3" style="margin-top:10px">
                                <a style="color:black;">角色 :</a>
                                <select id="role" style="width:auto">
                                    <option> 請選擇角色 </option>
                                </select>
                            </div>
                            <div class="col-xs-3" style="margin-top:10px">
                                <a style="color:black;">密碼 :</a> <input style="margin: auto" id="new_pwd" type="password" />
                            </div>
                            <div class="col-xs-3" style="margin-top:10px">
                                <input id="new_pwd_again" placeholder="確認密碼" type="password" style="margin: auto" />
                            </div>
                            <div class="col-xs-3" style="margin-top:10px">
                                <button class="btn btn-primary" id="btninsert" type="button">新增</button>
                            </div>
                        </div>
                        <div class="row deletebutton">
                            <div class="col-xs-6" style="text-align:left">
                                <button class="btn btn-danger btn-lg" id="btndelete" type="button">刪除</button>
                            </div>
                            <div class="col-xs-3">
                                <form enctype="multipart/form-data" id="csv_formdata" name="csv_formdata">
                                    <input accept=".csv" id="file" style="display:none" type="file" />
                                </form>
                            </div>
                            <div class="col-xs-3">
                                <button class="btn btn-success btn-lg" id="upcsv" type="button">匯入CSV</button>
                            </div>
                        </div>
                        <div class="row message">
                            <div style="margin-left:10px">
                                <h1 style="font-size: 20px">帳號清單</h1>
                                <br />
                                <div class="box-body">
                                    <table class="table table-bordered table-striped" id="example1" style="border:1px #000000 solid;">
                                        <thead>
                                            <tr>
                                                <th style="display:none;">ID</th>
                                                <th><input id="CheckAll" name="CheckAll" type="checkbox" /></th>
                                                <th>帳號</th>
                                                <th>角色</th>
                                                <th>姓名</th>
                                                <th>建立日期</th>
                                                <th>功能</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            <div class="modal fade" id="modal-default">
                <div class="modal-dialog" style="width:400px">
                    <div class="modal-content">
                        <div class="modal-header" style="background-color:#5991C9">
                            <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <h4 class="modal-title" style="color:white">帳號編輯</h4>
                        </div>
                        <div class="modal-body">
                            <div class="box-body">
                                <div class="row">
                                    <div class="col-xs-3"><a style="color:black;font-size: 16px">帳號 :</a></div>
                                    <div class="col-xs-6"><input id="edit_acc" type="text" /></div>
                                </div>
                                <br />
                                <div class="row">
                                    <div class="col-xs-3"><a style="color:black;font-size: 16px">姓名 :</a></div>
                                    <div class="col-xs-6"><input id="edit_name" type="text" /></div>
                                </div>
                                <br />
                                <div class="row">
                                    <div class="col-xs-3"><a style="color:black;font-size: 16px">信箱 :</a></div>
                                    <div class="col-xs-6"><input id="edit_email" type="text" /></div>
                                </div>
                                <br />
                                <div class="row">
                                    <div class="col-xs-3"><a style="color:black;font-size: 16px">角色 :</a></div>
                                    <div class="col-xs-6">
                                        <select id="edit_role">
                                            <option> 請選擇角色 </option>
                                        </select>
                                    </div>
                                </div>
                                <br />
                                <div class="row">
                                    <div class="col-xs-3"><a style="color:black;font-size: 16px">密碼 :</a></div>
                                    <div class="col-xs-6"><input id="edit_pwd" type="password" /></div>
                                </div>
                                <br />
                                <div class="row">
                                    <div class="col-xs-3" style="text-align:center;"></div>
                                    <div class="col-xs-6">
                                        <input id="edit_pwd_again" placeholder="密碼確認" type="password" />
                                    </div>
                                </div>
                                <br />
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-default" id="save" type="button">儲存</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="bower_components/fastclick/lib/fastclick.js"></script>
    <script src="dist/js/adminlte.min.js"></script>
    <script src="bower_components/jquery-sparkline/dist/jquery.sparkline.min.js"></script>
    <script src="plugins/jvectormap/jquery-jvectormap-1.2.2.min.js"></script>
    <script src="plugins/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
    <script src="bower_components/jquery-slimscroll/jquery.slimscroll.min.js"></script>
    <script src="dist/js/cookie.js"></script>
    <script src="bower_components/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="dist/js/demo.js"></script>
    <script>
        function edit_fun(mem_id) {
            var token = GetCookie("token");
            SetCookie("mem_id", mem_id, 1, domain);
            $.ajax({
                type: "POST",
                url: "phpMod/account_get_edit_list.php",
                async: false,
                dataType: "json",
                data: {
                    token: token,
                    userid: mem_id
                },
                success: function(data) {
                    if (checkMsg(data.msg)) {
                        $("#edit_acc").val(data.out["acc"]);
                        $("#edit_name").val(data.out["mem_name"]);
                        $("#edit_email").val(data.out["email"]);
                        $("#edit_role").val(data.out["rol_id"]);
                    }
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                }
            });
        }
        $(function() {
            $("#example2").DataTable({
                paging: true,
                lengthChange: true,
                searching: false,
                ordering: false,
                info: true,
                autoWidth: false,
                oLanguage: {
                    sProcessing: "處理中...",
                    sLengthMenu: "顯示 _MENU_ 項結果",
                    sZeroRecords: "沒有匹配結果",
                    sInfo: "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
                    sInfoEmpty: "顯示第 0 至 0 項結果，共 0 項",
                    sInfoFiltered: "(從 _MAX_ 項結果過濾)",
                    sSearch: "搜尋:",
                    oPaginate: {
                        sFirst: "首頁",
                        sPrevious: "上一頁",
                        sNext: "下一頁",
                        sLast: "尾頁"
                    }
                }
            });



            function updateDataTableSelectAllCtrl(table) {
                var $table = table.table().node();
                var $chkbox_all = $('tbody input[name="checkbox"]', $table);
                var $chkbox_checked = $('tbody input[name="checkbox"]:checked', $table);
                var chkbox_select_all = $('thead input[id="CheckAll"]', $table).get(0);

                if ($chkbox_checked.length === 0) {
                    chkbox_select_all.checked = false;
                    if ("indeterminate" in chkbox_select_all) {
                        chkbox_select_all.indeterminate = false;
                    }
                } else if ($chkbox_checked.length === $chkbox_all.length) {
                    chkbox_select_all.checked = true;
                    if ("indeterminate" in chkbox_select_all) {
                        chkbox_select_all.indeterminate = false;
                    }
                } else {
                    chkbox_select_all.checked = true;
                    if ("indeterminate" in chkbox_select_all) {
                        chkbox_select_all.indeterminate = true;
                    }
                }
            }

            var opt = {
                paging: true,
                lengthChange: true,
                searching: true,
                ordering: false,
                info: true,
                autoWidth: false,
                columnDefs: [{
                    targets: [0],
                    visible: false
                }],
                oLanguage: {
                    sProcessing: "處理中...",
                    sLengthMenu: "顯示 _MENU_ 項結果",
                    sZeroRecords: "沒有匹配結果",
                    sInfo: "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
                    sInfoEmpty: "顯示第 0 至 0 項結果，共 0 項",
                    sInfoFiltered: "(從 _MAX_ 項結果過濾)",
                    sSearch: "搜尋:",
                    oPaginate: {
                        sFirst: "首頁",
                        sPrevious: "上一頁",
                        sNext: "下一頁",
                        sLast: "尾頁"
                    }
                }
            };

            var token = GetCookie("token");
            var table = $("#example1").DataTable(opt);
            var user_name = GetCookie("user_name");
            $("#username").text(user_name);
            var usertitle = GetCookie("role_name");
            $("#usertitle").text(usertitle);
            $.ajax({
                type: "POST",
                url: "phpMod/account_get_role.php",
                async: false,
                dataType: "json",
                data: {
                    token: token
                },
                success: function(data) {
                    if (checkMsg(data.msg)) {
                        var role = data.out;
                        var role_length = role.length;
                        for (var i = 0; i < role_length; i++) {
                            var o = new Option(role[i]["name"], role[i]["id"]);
                            $("#role").append(o);
                            var edit_opt = new Option(role[i]["name"], role[i]["id"]);
                            $("#edit_role").append(edit_opt);
                        }
                    }
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                }
            });

            $.ajax({
                type: "POST",
                url: "phpMod/menu.php",
                async: false,
                dataType: "json",
                data: {
                    token: token,
                    page: 2,
                    subpage: 0
                },
                success: function(data) {
                    if (checkMsg(data.msg)) {
                        var menu = data.remenu;
                        $("#menu").append(menu);
                    }
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                }
            });

            $.ajax({
                type: "POST",
                url: "phpMod/account_get_list.php",
                async: false, ///非同步執行
                dataType: "json",
                data: {
                    token: token
                },
                success: function(data) {
                    if (!checkMsg(data.msg)) {
                        DelCookie("token", domain);
                        document.location.href = "login.html";
                    }
                    if (checkMsg(data.msg)) {
                        for (var i = 0; i < data.out.length; i++) {
                            var data_array = data.out[i];
                            var mem_id = data_array["mem_id"];
                            var account = data_array["acc"];
                            var create_time = data_array["created_at"];
                            var mem_name = data_array["mem_name"];
                            var rol_id = data_array["rol_id"];
                            var rol_name = data_array["rol_name"];

                            table.row
                                .add([
                                    mem_id,
                                    "<input type='checkbox' id='" + mem_id + "' name='checkbox'/>",
                                    account,
                                    rol_name,
                                    mem_name,
                                    create_time,
                                    "<button type='button' class='btn btn-warning btn-sm' data-toggle='modal' data-target='#modal-default' onClick=edit_fun(this.id) id='" +
                                    mem_id +
                                    "' value='" +
                                    mem_id +
                                    "'>編輯<\/button>"
                                ])
                                .draw(false);
                        }
                    }
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                }
            });
            $("#example1 tbody").on("click", 'input[name="checkbox"]', function(e) {
                var table = $("#example1").DataTable();
                var $row = $(this).closest("tr");
                if (this.checked) {
                    $row.addClass("selected");
                } else {
                    $row.removeClass("selected");
                }
                updateDataTableSelectAllCtrl(table);
            });

            $("#CheckAll").click(function() {
                var table = $("#example1").DataTable();
                if ($("#CheckAll").prop("checked")) {
                    $("input[name='checkbox']").each(function() {
                        $(this).prop("checked", true);
                        $(this)
                            .closest("tr")
                            .addClass("selected");
                    });
                } else {
                    $("input[name='checkbox']").each(function() {
                        $(this).prop("checked", false);
                        $(this)
                            .closest("tr")
                            .removeClass("selected");
                    });
                }
            });

            $("#save").click(function() {
                var token = GetCookie("token");
                var mem_id = GetCookie("mem_id");
                var sno_roles = $("#edit_role").val();
                var account = $("#edit_acc").val();
                var passwd = $("#edit_pwd").val();
                var pwd_check = $("#edit_pwd_again").val();
                var email = $("#edit_email").val();
                var name = $("#edit_name").val();
                if (passwd == "" || passwd != pwd_check || pwd_check == "") {
                    alert("密碼錯誤");
                } else {
                    $.ajax({
                        type: "POST",
                        url: "phpMod/account_edit.php",
                        async: false,
                        dataType: "json",
                        data: {
                            token: token,
                            userid: mem_id,
                            sno_roles: sno_roles,
                            account: account,
                            passwd: passwd,
                            name: name,
                            email: email
                        },
                        success: function(data) {
                            if (checkMsg(data.msg)) {
                                alert("編輯成功");
                                document.location.href = "account.html";
                            }
                            if (checkMsg(data.msg) == "207") {
                                alert("帳號重複");
                            }
                        },
                        error: function(XMLHttpRequest, textStatus, errorThrown) {
                            alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                        }
                    });
                }
            });

            $("#btninsert").click(function() {
                var token = GetCookie("token");
                var sno_roles = $("#role").val();
                var account = $("#new_acc").val();
                var passwd = $("#new_pwd").val();
                var pwd_check = $("#new_pwd_again").val();
                var email = $("#new_email").val();
                var name = $("#new_name").val();
                if (passwd == "" || passwd != pwd_check || pwd_check == "") {
                    alert("密碼錯誤");
                } else {
                    $.ajax({
                        type: "POST",
                        url: "phpMod/account_insert.php",
                        async: false,
                        dataType: "json",
                        data: {
                            token: token,
                            sno_roles: sno_roles,
                            account: account,
                            passwd: passwd,
                            name: name,
                            email: email
                        },
                        success: function(data) {
                            if (checkMsg(data.msg)) {
                                alert("新增成功");
                                document.location.href = "account.html";
                            }
                            if (!checkMsg(data.msg)) {
                                alert("帳號重複");
                            }
                        },
                        error: function(XMLHttpRequest, textStatus, errorThrown) {
                            alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                        }
                    });
                }
            });

            $("#btndelete").click(function(e) {
                var delete_bool = confirm("確定要勾選資料?");
                if (delete_bool == true) {
                    var table = $("#example1").DataTable();
                    var $table = table.table().node();
                    var $chkbox_all = $('tbody input[name="checkbox"]', $table);
                    var $chkbox_checked = $('tbody input[name="checkbox"]:checked', $table);
                    var chkbox_select_all = $('thead input[id="CheckAll"]', $table).get(0);
                    var Data = table.rows(".selected").data();
                    var id = "0";
                    for (var i = 0; i < Data.length; i++) {
                        if (id == "0") id = Data[i][0];
                        else id += "," + Data[i][0];
                    }

                    $.ajax({
                        type: "POST",
                        url: "phpMod/account_delete.php",
                        async: false,
                        dataType: "json",
                        data: {
                            token: token,
                            userid: id
                        },
                        success: function(data) {
                            alert("刪除成功");
                            document.location.href = "account.html";
                        },
                        error: function(XMLHttpRequest, textStatus, errorThrown) {
                            alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                        }
                    });
                }
            });

            $("#upcsv").click(function() {
                $("#file").trigger("click");
            });

            $("input[type=file]").change(function() {
                var token = GetCookie("token");

                var formdata = new FormData($("#csv_formdata"));
                formdata.append("token", token);
                formdata.append("csv", $("input[type=file]")[0].files[0]);
                $.ajax({
                    type: "POST",
                    url: "phpMod/account_insert_csv.php",
                    async: false,
                    data: formdata,
                    cache: false,
                    processData: false,
                    contentType: false,
                    success: function(data) {
                        if (checkMsg(data.msg)) {
                            if (data.out == "") {
                                alert("CSV上傳成功");
                                document.location.href = "account.html";
                            } else {
                                var acc = data.out.split(",");
                                alert(data.out + "帳號有重複");
                                document.location.href = "account.html";
                            }
                        } else {
                            if (data.msg == "401") {
                                alert("格式錯誤");
                            } else {
                                alert("上傳失敗");
                            }
                        }
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                        alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                    }
                });
            });

            $("#logout_btn").click(function() {
                $.ajax({
                    type: "POST",
                    url: "phpMod/signout_serve.php",
                    async: false,
                    dataType: "json",
                    data: {
                        token: token
                    },
                    success: function(data) {
                        if (checkMsg(data.msg)) {
                            delete_all_cookie();
                        }
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                        alert(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
                    }
                });
            });
        });
    </script>
</body>

</html>